version: '3.1'
services:
  config:
    image: ecom-config-server:latest
    restart: always
    container_name: ecom-config-server
    hostname: ${CONFIG_HOSTNAME}
    environment:
      server.port: ${CONFIG_PORT}
      spring.profiles.active: ${CONFIG_SPRING_PROFILES}
    expose:
      - ${CONFIG_PORT}
    ports:
      - ${CONFIG_PORT}:${CONFIG_PORT}
    networks:
      - ecom-network
  discovery:
    image: ecom-discovery-server:latest
    restart: always
    container_name: ecom-discovery-server
    hostname: ${DISCOVERY_HOSTNAME}
    depends_on:
      - config
    environment:
      server.port: ${DISCOVERY_PORT}
      spring.profiles.active: ${DISCOVERY_SPRING_PROFILES}
      CONFIG_SERVER_ADDRESS: ${CONFIG_HOSTNAME}
      CONFIG_SERVER_PORT: ${CONFIG_PORT}
    expose:
      - ${DISCOVERY_PORT}
    ports:
      - ${DISCOVERY_PORT}:${DISCOVERY_PORT}
    networks:
      - ecom-network
  gateway:
    image: ecom-gateway-server:latest
    restart: always
    container_name: ecom-gateway-server
    hostname: ${GATEWAY_HOSTNAME}
    depends_on:
      - config
      - mongo
    environment:
      server.port: ${GATEWAY_PORT}
      spring.profiles.active: ${GATEWAY_SPRING_PROFILES}
      CONFIG_SERVER_ADDRESS: ${CONFIG_HOSTNAME}
      CONFIG_SERVER_PORT: ${CONFIG_PORT}
      DISCOVERY_SERVER_ADDRESS: ${DISCOVERY_HOSTNAME}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_PORT}
    expose:
      - ${GATEWAY_PORT}
    ports:
      - ${GATEWAY_PORT}:${GATEWAY_PORT}
    networks:
      - ecom-network
  user:
    image: ecom-user-server:latest
    restart: always
    container_name: ecom-user-server
    hostname: ${USER_HOSTNAME}
    depends_on:
      - config
      - keycloak
    environment:
      server.port: ${USER_PORT}
      spring.profiles.active: ${USER_SPRING_PROFILES}
      CONFIG_SERVER_ADDRESS: ${CONFIG_HOSTNAME}
      CONFIG_SERVER_PORT: ${CONFIG_PORT}
      DISCOVERY_SERVER_ADDRESS: ${DISCOVERY_HOSTNAME}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_PORT}
    expose:
      - ${USER_PORT}
    ports:
      - ${USER_PORT}:${USER_PORT}
    networks:
      - ecom-network
  ui:
    image: ecom-ui-server:latest
    restart: always
    container_name: ecom-ui-server
    hostname: ${UI_HOSTNAME}
    depends_on:
      - config
      - user
      - keycloak
    environment:
      server.port: ${UI_PORT}
      spring.profiles.active: ${UI_SPRING_PROFILES}
      CONFIG_SERVER_ADDRESS: ${CONFIG_HOSTNAME}
      CONFIG_SERVER_PORT: ${CONFIG_PORT}
      DISCOVERY_SERVER_ADDRESS: ${DISCOVERY_HOSTNAME}
      DISCOVERY_SERVER_PORT: ${DISCOVERY_PORT}
    expose:
      - ${UI_PORT}
    ports:
      - ${UI_PORT}:${UI_PORT}
    networks:
      - ecom-network
  postgres:
    image: postgres:13.2
    container_name: ecom-postgres
    hostname: postgres
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - 5432:5432
    networks:
      - ecom-network
  keycloak:
    image: jboss/keycloak:latest
    container_name: ecom-keycloak
    hostname: keycloak
    environment:
      DB_VENDOR: postgres
      DB_ADDR: postgres
      DB_DATABASE: keycloak
      DB_USER: user
      DB_PASSWORD: password
      KEYCLOAK_USER: user
      KEYCLOAK_PASSWORD: password
    depends_on:
      - postgres
    volumes:
      - ./volumes/keycloak/imports:/opt/jboss/keycloak/imports
    command:
      - '-b 0.0.0.0 -Dkeycloak.import=/opt/jboss/keycloak/imports/realm-export.json'
    ports:
      - 8080:8080
    networks:
      - ecom-network
networks:
  ecom-network:
    driver: bridge